var CP_InputCreate=function(e,t,n,o,c,l,s){function i(){g&&(clearInterval(g),g=null),v&&(clearTimeout(v),v=null),h&&(clearTimeout(h),h=null)}function u(e,t,n){if(console.info("[Input] socket start connect, tryTime: "+n+", url : "+e+", cp status: "+Cloudplay.isStoped()+", isReconnecting: "+Cloudplay.isReconnecting()),!Cloudplay.isStoped()&&!Cloudplay.isReconnecting()){if(Cloudplay.sendCountly(countly_event_id_map.input_socket_connecting),n>=s)return console.log("[Input] reconnect exceed max time and refresh token"),Cloudplay.sendCountly(countly_event_id_map.input_socket_connect_failed),void p.emit("cp.reconnect",1);i(),m=new WebSocket(e,t);var o=!1,a=m;m.onopen=function(){return a!=m?(Cloudplay.sendCountly(countly_event_id_map.input_socket_check_failed,"onopen"),void console.log("[Input] onopen socket check error")):(Cloudplay.sendCountly(countly_event_id_map.input_socket_connect_opend),console.log("[Input] socket opened"),o=!0,void(g=setInterval(function(){var e="ping:"+Date.now();console.log("[Input] socket send ping message",e),CP_UTILS.websocket_send(m,e)},c||6e4)))},m.onmessage=function(e){if(a!=m)return Cloudplay.sendCountly(countly_event_id_map.input_socket_check_failed,"onmessage"),void console.log("[Input] onmessage socket check error");var t=e.data;console.log("[Input] socket got message: "+t),";"==t.charAt(t.length-1)&&(t=t.substr(0,t.length-1));var n=null,o=t.indexOf(":");switch(n=o>=0?t.substr(0,o).toLowerCase():t.toLowerCase()){case"pong":var c=Date.now(),s=t.substr(o+1),i=c-s;Cloudplay.sendCountly(countly_event_id_map.input_socket_ping_pong_delay_time,i),i>=l&&Cloudplay.sendCountly(countly_event_id_map.input_socket_ping_pong_delay_max,i);break;case"startIM".toLowerCase():Cloudplay.sendCountly(countly_event_id_map.input_socket_start_im);var u=t.indexOf(",");if(u==-1||u<o){console.log("[Input] socket got invalid startIM message: "+t);break}var r=parseFloat(t.substr(o+1,u-(o+1))),_=parseFloat(t.substr(u+1));p.emit("cp.start_im",r,_);break;case"stopIM".toLowerCase():Cloudplay.sendCountly(countly_event_id_map.input_socket_stop_im),p.emit("cp.stop_im");break;default:console.warn("[Input] socket got invalid message: "+t)}},m.onclose=function(c){if(a!=m)return Cloudplay.sendCountly(countly_event_id_map.input_socket_check_failed,"onclose"),void console.log("[Input] onclose socket check error");var l=c&&c.code?c.code:-1;return console.log("[Input] socket close! code: "+l+", Cloudplay.isStoped(): "+Cloudplay.isStoped()+", Cloudplay.isReconnecting(): "+Cloudplay.isReconnecting()),Cloudplay.sendCountly(countly_event_id_map.input_socket_connect_closed,l),r(),o?void(h=setTimeout(function(){__hmLogWarn("[Input] socket was closed and refresh token",CP_ERROR_MAP.input_socket_close_and_refresh_token),p.emit("cp.reconnect",1)},3e3)):void(v=setTimeout(function(){console.log("[Input] socket reconnect"),u(e,t,n+1)},3e3))}}}function a(){return m?void __hmLogError("[Input] socket connect multi time",CP_ERROR_MAP.input_socket_connect_multi_time):void u(n,o,0)}function r(){i(),CP_UTILS.websocket_close(m,!1),m=null,p.emit("cp.stop_im"),d()}function _(e){if(console.log("[Input] start input listener"),d(),y=document.getElementById(e),!y)return void __hmLogError("[Input] player object not found",CP_ERROR_MAP.js_player_object_not_found);var t=y.getBoundingClientRect();f.x=t.left,f.y=t.top,f.width=t.right-t.left,f.height=t.bottom-t.top,console.log("[Input] player rect: x: "+f.x+", y: "+f.y+", width: "+f.width+", height: "+f.height),y.addEventListener("touchstart",b,C),y.addEventListener("touchmove",R,C),y.addEventListener("touchend",x,C),y.addEventListener("touchcancel",P,C)}function d(){y&&(y.removeEventListener("touchstart",b,C),y.removeEventListener("touchmove",R,C),y.removeEventListener("touchend",x,C),y.removeEventListener("touchcancel",P,C),y=null)}console.info("[Input] start init: "+n+", isPortraitGame: "+t+", maxTryTime: "+s);var p=e,m=null,g=null,v=null,h=null,y=null,C=!0,f={x:0,y:0,width:0,height:0},k=1,I=2,T=3,w=function(e){var t=e-f.x;return t<0&&(t=0),t>f.width&&(t=f.width),(t/f.width).toFixed(4)},L=function(e){var t=e-f.y;return t<0&&(t=0),t>f.height&&(t=f.height),(t/f.height).toFixed(4)},E=function(e,t,n){e.preventDefault(),e.stopPropagation();for(var o=0;o<e.changedTouches.length;o++){var c=e.changedTouches[o],l=w(c.clientX),s=L(c.clientY),i=l;l=s,s=1-i,console.log("[Input] "+n+": x: "+l+", y: "+s);var u="mouse:"+t+":"+l+","+s;CP_UTILS.websocket_send(m,u)}},b=function(e){E(e,k,"_onTouchStart"),p.emit(CP_CONSTANT.EVENT_TOUCH_START)},R=function(e){E(e,T,"_onTouchMove")},x=function(e){E(e,I,"_onTouchEnd")},P=function(e){E(e,I,"_onTouchCancel")};return{connectSocket:a,close:function(){console.log("[Input] close the socket"),r()},startInputListener:_,stopInputListener:d}};
var CP_CloudplayUIInit=function(t){function n(){var t=CP_UTILS.getSessionStore("game_options");return t&&t.isPortrait}function i(t){t.preventDefault()}function o(e,n){if(t(e).length>1)return __hmLogWarn("error: only support single player",CP_ERROR_MAP.multi_player),!1;if(t(e).length<=0)return __hmLogError("error: no player wrap found",CP_ERROR_MAP.no_player_wrap),!1;W=e,L=n,t(W).on("contextmenu",function(t){t.preventDefault()});var i=null;return i=y?{containerId:t(W).attr("id"),width:N.width,height:N.height,videoUrl:"ws://"+N.ip+":"+N.videoPort+"/",audioUrl:"ws://"+N.ip+":"+N.audioPort,isPortraitGame:N.isPortraitGame}:{containerId:t(W).attr("id"),width:n.vedioWidth,height:n.vedioHeight,videoUrl:n.videoUrl,audioUrl:n.audioUrl,isPortraitGame:M},(k=CP_JsPlayerInit(A,i))?(k.start(),b.startInputListener(k.id()),!0):void A.emit(CP_CONSTANT.EVENT_STOP_SDK,"创建播放器失败")}function a(t,e,n,i){w=e,O=n,U=i}function s(t){console.log("start play and option:",t),Cloudplay.sendCountly(countly_event_id_map.start_revolution),A.emit("cp.sceneChanged","play",{cur_rate:-1}),o(W,t)}function l(t){console.log("stop play and isReset:"+t+", gPlayer: "+k+", gInput: "+b),k&&k.stop(!0),k=null,b&&(b.close(),b=null)}function r(){return k&&k.isPlaying()}function c(){return-1}function d(){return!1}function _(t,e,n){}function u(t,e){b&&(b.close(),b=null);var n=t;y&&(n="ws://"+N.ip+":"+N.inputPort+"/testingBackDoor"),b=CP_InputCreate(A,M,n,e,U.ping_interval_time,U.ping_delay_time,3),b.connectSocket()}function p(t){this.stopPlay(!1),T(!1),t&&E(CP_CONSTANT.UI_MESSAGE_TYPE_SYSTEM,t)}function h(){}function m(){if(console.log("rtmp_options:",L),console.log("saas_system_config:",U),void 0!=U.floating_app_name){t(".floatingBar").length>0&&t(".floatingBar").remove();var e="_aLink";CP_UTILS.isInWeixin()&&(e="_download"),html='<div class="floatingBar">                    <div class="time">                        <div class="cross">                        </div>                        <div>                            <div class="full-width-height center">                                <div class="countdownContainer">                                    <p class="countdownNumber"></p>                                </div>                            </div>                            <div class="full-width-height center">                                <svg class="circular">                                    <circle class="path" cx="15" cy="15" r="13.9" fill="none" stroke-width="3" stroke-miterlimit="10" />                                </svg>                            </div>                        </div>                    </div>                    <span class="game-img"><img src="'+U.floating_icon_url+'" alt="" /></span>                    <span class="game-name">'+U.floating_app_name+'</span>                    <span class="game-btn">                        <a class="ios '+e+'" target="_blank" href="'+U.floating_app_url+'"><img src="'+Y+'/ios.png" alt="" /></a>                        <a class="android '+e+'" target="_blank" href="'+U.floating_app_url+'"><img src="'+Y+'/android.png" alt="" /></a>                    </span>                </div>',M||!CP_UTILS.isSupportDevice()?(t("#playGameBox").append(html),CP_UTILS.isSupportDevice()||T(!1)):t(W).append(html);var n;L&&null!=L.remindTime&&"null"!=L.remindTime?(n=Math.round(L.remindTime/1e3),C(n)):n=0}}function g(){t(".floatingBar").remove()}function C(e){B!=-1&&clearInterval(B),B=setInterval(function(){e>=1?(e--,t(".countdownNumber").html(e)):T(!0)},1e3)}function T(e){B!=-1&&(clearInterval(B),B=-1,t(".floatingBar > .time").css({opicty:0,visibility:"hidden"}),e&&A.emit(CP_CONSTANT.EVENT_STOP_SDK,w.prompt_game_over))}function v(e,n){var i="",o="",a="",s="";switch(t(".LockScreen").remove(),e){case CP_CONSTANT.UI_MESSAGE_TYPE_PORTRAIT:i="portrait",o="在竖屏下锁定屏幕<br>并竖屏游戏",s="LockScreen";break;case CP_CONSTANT.UI_MESSAGE_TYPE_LANDSCAPE:i="landscape",o="在竖屏下锁定屏幕<br>并横屏游戏",s="LockScreen";break;case CP_CONSTANT.UI_MESSAGE_TYPE_IOSWECHAT:s=H,a="iosWeChat",o='<img width="200" src="'+Y+'/ios-wechat.png" alt="" />';break;case CP_CONSTANT.UI_MESSAGE_TYPE_ANDROIDWECHAT:s=H,a="androidWeChat",o='<img width="200" src="'+Y+'/Android-wechat.png" alt="" />'}var l='<div class="backgroundCover '+s+'">                    <a class="bgUpInfomationBox '+a+'">                         <i class="'+i+'"></i>                         <p class="p2">'+o+"</p>                    </a>                </div>";t("#playGameBox").append(l);var r=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,c=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;if(!CP_UTILS.isInWeixin()||"portrait"!=i&&"landscape"!=i?t(".backgroundCover").css({width:r,height:c}):t(".backgroundCover").css({width:c+64,height:r}),s===H){var d={title:"download",url:"#"};window.history.pushState(d,"title","#")}}function P(){t(".LockScreen").remove()}function E(e,n){var i="",o="",a="";switch(e){case CP_CONSTANT.UI_MESSAGE_TYPE_UNSUPPORT:m(),i="unsupported",o="您的设备暂不支持",a="systemUnsupported";break;case CP_CONSTANT.UI_MESSAGE_TYPE_SYSTEM:i="system",o=n,a="systemInfo"}t(".systemInfo").remove(),Cloudplay.sendCountly(countly_event_id_map.show_info_page,o?encodeURIComponent(o):"");var s='<div class="backgroundCover '+a+'">                    <a class="bgUpInfomationBox">                         <i class="'+i+'"></i>                         <p class="p2">'+o+"</p>                    </a>                </div>",l=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,r=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;console.log("this Game Is Portrait Game: ",M),M?(t("#playGameBox").append(s),t("#playGameBox .backgroundCover").css({width:l,height:r})):(t(W).append(s),"been_ready"==D?t("#playGameBox .backgroundCover").css({width:r,height:l}):t("#playGameBox .backgroundCover").css({width:l,height:r}))}function S(){t("."+x).remove()}function I(){t("."+H).remove()}function f(t){A.emit("cp.get_notice",R,t)}var N={ip:"172.16.40.218",videoPort:9911,audioPort:7766,inputPort:7681,width:720,height:404,isPortraitGame:!1},y=!1,A=Cloudplay.eventEmitter();A||__hmLogError("Cloudplay.eventEmitter is null",CP_ERROR_MAP.eventEmitterIsNull);var w={},O={},U={},R=1,L=null,k=null,b=null,D="",G=CP_UTILS.getBasePath("saas-sdk.js");G||(G=CP_UTILS.getBasePath("cloudplay.js"));var Y=G+"images",W=function(){console.info("cp_ui start init player div with image path: "+Y),document.getElementById(CP_CONSTANT.UI_PLAYER_CONTAINER_ID)||(__hmLogError("div: id = "+CP_CONSTANT.UI_PLAYER_CONTAINER_ID+" is NOT exist",CP_ERROR_MAP.player_container_not_exist),alert("div: id = "+CP_CONSTANT.UI_PLAYER_CONTAINER_ID+" is NOT exist"));var e='<div class="'+CP_CONSTANT.UI_PLAYER_DIV_CLASS+'" id="'+CP_CONSTANT.UI_PLAYER_DIV_ID+'"></div>';return t("#"+CP_CONSTANT.UI_PLAYER_CONTAINER_ID).append(e),"."+CP_CONSTANT.UI_PLAYER_DIV_CLASS}(),M=n();document.getElementById(CP_CONSTANT.UI_PLAYER_CONTAINER_ID).addEventListener("touchmove",i,!0),A.on("cp.get_notice",function(t,e){});var B=-1,x="messageView",H="downloadView";return A.on(CP_CONSTANT.EVENT_ORIENTATION_CHANGE,function(e){if(90==orientation||orientation==-90)v(M?CP_CONSTANT.UI_MESSAGE_TYPE_PORTRAIT:CP_CONSTANT.UI_MESSAGE_TYPE_LANDSCAPE);else{P();var n=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,i=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;t("."+H).length>0?t("."+H).css({width:i+52,height:n,left:0,top:0}):(t(".systemUnsupported").css({width:n,height:i,left:0,top:0}),M?CP_UTILS.isInWeixin()?t(".systemInfo").css({width:i,height:n,left:"20px",top:0}):t(".systemInfo").css({width:n,height:i,left:0,top:0}):CP_UTILS.isInWeixin()?t(".systemInfo").css({width:n,height:i,left:0,top:0}):t(".systemInfo").css({width:i,height:n,left:0,top:0}));var o=k.getCanvasInfo(),a=o.id;console.log("gobal Canvas info："+JSON.stringify(o)),t("#"+a).length>0&&t("#"+a).css({left:o.style.left,top:o.style.top,width:o.style.width,height:o.style.height})}}),A.on(CP_CONSTANT.EVENT_PLAYER_READY,function(){m(),D="been_ready"}),window.onpopstate=function(t){console.log("onpopstate event state: "+t.state),I()},t(document).on("click","._download",function(t){t.preventDefault(),v(CP_CONSTANT.UI_MESSAGE_TYPE_IOSWECHAT),Cloudplay.sendCountly(countly_event_id_map.click_download)}).on("click","._aLink",function(t){Cloudplay.sendCountly(countly_event_id_map.click_download)}).on("click","._downloadAndroid",function(){e.preventDefault(),v(CP_CONSTANT.UI_MESSAGE_TYPE_ANDROIDWECHAT),Cloudplay.sendCountly(countly_event_id_map.click_download)}),{setAuthData:a,startPlay:s,stopPlay:l,isPlayerRunning:r,curResId:c,isUserSelectedResMode:d,askQueuing:_,setCurrentResId:h,connectInputSocket:u,stop:p,showFloatBar:m,hideFloatBar:g,showMessageView:E,hideMessageView:S,showWarnToast:f}};